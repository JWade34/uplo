<% content_for :title, "#{@photo.title.present? ? @photo.title : "Photo ##{@photo.id}"} | Uplo" %>
<% content_for :description, "#{@photo.description.present? ? @photo.description : "View AI-generated captions for this gym photo"} - Created with Uplo's AI-powered social media tools for personal trainers." %>
<% content_for :robots, "noindex, follow" %>

<!-- Photo Detail Page -->
<div class="min-h-screen bg-gray-50">
  <%= render 'shared/navigation' %>

  <!-- Main Content -->
  <div class="max-w-6xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-8">
    
    <!-- Flash Message -->
    <% if flash[:notice] %>
      <div class="mb-4 sm:mb-6 bg-accent text-black p-3 sm:p-4 rounded-lg text-center font-semibold text-sm sm:text-base">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- Mobile-First Layout: Photo, then Captions, then Details -->
    <div class="space-y-6">
      <!-- Photo Display (Social Media Style) -->
      <div style="width: 367px; margin: 0 auto;">
        <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
          <% if @photo.image.attached? %>
            <% if @photo.heic_file? %>
              <!-- HEIC Image - Show actual converted image -->
              <div class="relative aspect-square bg-gray-100">
                <%= image_tag @photo.display_image_url, class: "w-full h-full object-cover", alt: @photo.title %>
                <div class="absolute top-3 right-3 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                  HEIC
                </div>
              </div>
            <% else %>
              <div class="aspect-square bg-gray-100">
                <%= image_tag @photo.display_image, class: "w-full h-full object-cover", alt: @photo.title %>
              </div>
            <% end %>
          <% else %>
            <div class="aspect-square bg-gray-100 flex items-center justify-center">
              <span class="text-gray-400 text-6xl">üì∏</span>
            </div>
          <% end %>
          
          <!-- Social Media Post-Style Info Bar -->
          <div class="p-4 border-t border-gray-100">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h2 class="font-semibold text-gray-900 text-sm sm:text-base">
                  <%= @photo.title.present? ? @photo.title : "Photo ##{@photo.id}" %>
                </h2>
                <p class="text-xs sm:text-sm text-gray-500 mt-1">
                  Uploaded <%= time_ago_in_words(@photo.created_at) %> ago
                  <% if @photo.image.attached? %>
                    ‚Ä¢ <%= number_to_human_size(@photo.image.byte_size) %>
                  <% end %>
                </p>
              </div>
              <% unless @photo.processed? %>
                <div class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full ml-3">
                  <span class="hidden sm:inline">Processing...</span>
                  <span class="sm:hidden">‚è≥</span>
                </div>
              <% end %>
            </div>
            
            <% if @photo.description.present? %>
              <p class="text-sm text-gray-700 mt-2 leading-relaxed">
                <%= @photo.description %>
              </p>
            <% end %>
          </div>
        </div>
      </div>
      
      <!-- Desktop Layout Container -->
      <div class="lg:grid lg:grid-cols-2 lg:gap-8 lg:space-y-0 space-y-6">
        <!-- AI Captions Section (Second on mobile, Right column on desktop) -->
        <div class="lg:order-2 space-y-4 sm:space-y-6" data-controller="photo-polling" 
             data-photo-polling-url-value="<%= photo_path(@photo) %>"
             data-photo-polling-interval-value="3000"
             data-processing="<%= !@photo.processed? %>">
          <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3 sm:mb-4">
              <h2 class="text-lg sm:text-xl font-bold text-gray-900">AI Captions</h2>
              <% unless @photo.processed? %>
                <span class="bg-yellow-100 text-yellow-800 text-xs px-2 sm:px-3 py-1 rounded-full font-medium">
                  <span class="hidden sm:inline">Processing...</span>
                  <span class="sm:hidden">‚è≥</span>
                </span>
              <% end %>
            </div>
            
            <% if @photo.processed? && @photo.captions.any? %>
              <!-- Display Generated Captions -->
              <div class="space-y-3 sm:space-y-4">
                <% @photo.captions.recent.each_with_index do |caption, index| %>
                  <div class="border rounded-lg p-3 sm:p-4">
                    <div class="flex items-start justify-between mb-2">
                      <span class="text-xs sm:text-sm font-medium text-gray-700">
                        <span class="hidden sm:inline">Caption <%= index + 1 %> - <%= caption.style.humanize %></span>
                        <span class="sm:hidden"><%= caption.style.humanize %></span>
                      </span>
                      <button onclick="copyToClipboard('<%= caption.id %>')" class="text-xs text-accent hover:underline px-2 py-1 -m-1">
                        Copy
                      </button>
                    </div>
                    <p class="text-sm sm:text-base text-gray-900 leading-relaxed" id="caption-<%= caption.id %>"><%= caption.content %></p>
                    <div class="mt-2 text-xs text-gray-500">
                      <span class="hidden sm:inline">Generated <%= time_ago_in_words(caption.generated_at) %> ago</span>
                      <span class="sm:hidden"><%= time_ago_in_words(caption.generated_at) %> ago</span>
                    </div>
                  </div>
                <% end %>
              </div>
            <% elsif @photo.processed? %>
              <!-- No captions generated -->
              <div class="text-center py-6 sm:py-8">
                <div class="text-gray-400 text-3xl sm:text-4xl mb-3 sm:mb-4">‚ö†Ô∏è</div>
                <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-2">Caption Generation Failed</h3>
                <p class="text-sm sm:text-base text-gray-600 max-w-sm mx-auto mb-4 px-4">
                  We encountered an issue generating captions for this photo. This might be due to image quality or content.
                </p>
                <button onclick="window.location.reload()" class="bg-accent text-black px-4 py-2 rounded-lg font-semibold hover:bg-accent-hover transition-colors text-sm sm:text-base">
                  Try Again
                </button>
              </div>
            <% else %>
              <!-- Enhanced Processing State -->
              <div class="text-center py-6 sm:py-8" data-turbo-permanent>
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-4 max-w-xs mx-auto">
                  <div class="bg-accent h-2 rounded-full transition-all duration-1000 ease-out" 
                       style="width: <%= @photo.processing_progress_percentage %>%"></div>
                </div>
                
                <!-- Animated Icon -->
                <div class="animate-spin rounded-full h-6 w-6 sm:h-8 sm:w-8 border-b-2 border-accent mx-auto mb-3 sm:mb-4"></div>
                
                <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-2">
                  <span class="hidden sm:inline">AI Caption Generation in Progress</span>
                  <span class="sm:hidden">AI Processing</span>
                </h3>
                
                <div class="text-sm sm:text-base text-gray-600 max-w-sm mx-auto px-4 space-y-2">
                  <% if @photo.processing_started_at %>
                    <p>
                      Processing for <%= pluralize(@photo.processing_elapsed_seconds, 'second') %>...
                      <% if @photo.estimated_completion_time > 0 %>
                        <br><span class="text-xs text-gray-500">Est. <%= pluralize(@photo.estimated_completion_time, 'second') %> remaining</span>
                      <% end %>
                    </p>
                  <% end %>
                  
                  <p class="text-xs sm:text-sm">
                    Generating <%= @user.can_access_pro_features? ? '3 personalized caption styles' : '1 personalized caption' %> 
                    optimized for your fitness content.
                  </p>
                </div>
                
                <!-- Processing Steps -->
                <div class="mt-4 text-xs text-gray-500 space-y-1">
                  <div class="flex items-center justify-center space-x-2">
                    <span class="w-2 h-2 bg-accent rounded-full"></span>
                    <span>Image analysis complete</span>
                  </div>
                  <div class="flex items-center justify-center space-x-2">
                    <div class="w-2 h-2 border border-accent rounded-full animate-pulse"></div>
                    <span>Generating AI captions...</span>
                  </div>
                </div>
                
                <p class="text-xs text-gray-400 mt-4">Updates automatically ‚Ä¢ No need to refresh</p>
              </div>
              
              <!-- Auto-refresh with shorter interval for better UX -->
              <script>
                setTimeout(function() {
                  window.location.reload();
                }, 3000); // Refresh every 3 seconds while processing
              </script>
            <% end %>
          </div>

          <!-- Action Buttons -->
          <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Next Steps</h3>
            <div class="space-y-3">
              <% if @photo.processed? %>
                <button class="w-full bg-accent text-black py-3 rounded-lg font-semibold hover:bg-accent-hover transition-colors text-sm sm:text-base">
                  <span class="hidden sm:inline">üì± Schedule Post</span>
                  <span class="sm:hidden">üì± Schedule</span>
                </button>
                <button class="w-full border border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors text-sm sm:text-base">
                  <span class="hidden sm:inline">‚úèÔ∏è Edit Captions</span>
                  <span class="sm:hidden">‚úèÔ∏è Edit</span>
                </button>
              <% else %>
                <div class="w-full bg-gray-100 text-gray-500 py-3 rounded-lg font-semibold text-center text-sm sm:text-base">
                  <span class="hidden sm:inline">‚è≥ Waiting for AI processing...</span>
                  <span class="sm:hidden">‚è≥ Processing...</span>
                </div>
              <% end %>
              <%= link_to photos_path, class: "w-full border border-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors block text-center text-sm sm:text-base" do %>
                <span class="hidden sm:inline">üëÅÔ∏è View All Photos</span>
                <span class="sm:hidden">üëÅÔ∏è All Photos</span>
              <% end %>
            </div>
          </div>

          <!-- Social Media Variants (only show when available) -->
          <% if @photo.processed? && @photo.available_social_variants.any? %>
            <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6">
              <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Social Media Formats</h3>
              <p class="text-xs sm:text-sm text-gray-600 mb-4">Optimized versions for different platforms:</p>
              
              <div class="space-y-3">
                <% @photo.available_social_variants.each do |variant| %>
                  <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex-1">
                      <div class="font-medium text-gray-900 text-sm">
                        <%= variant[:display_name] %>
                      </div>
                      <div class="text-xs text-gray-500">
                        <%= variant[:dimensions] %>
                      </div>
                    </div>
                    <div class="flex space-x-2">
                      <%= link_to variant[:attachment], class: "text-accent hover:underline text-xs sm:text-sm px-2 py-1", target: "_blank" do %>
                        Preview
                      <% end %>
                      <%= link_to variant[:attachment], class: "bg-accent text-black px-3 py-1 rounded text-xs font-medium hover:bg-accent-hover transition-colors", download: variant[:attachment].filename do %>
                        Download
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
              
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-xs text-gray-600">
                  üí° <strong>Tip:</strong> Each format is optimized for maximum quality and engagement on its respective platform.
                </p>
              </div>
            </div>
          <% end %>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
function copyToClipboard(captionId) {
  const captionElement = document.getElementById('caption-' + captionId);
  const text = captionElement.textContent;
  
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => {
      showCopyFeedback();
    });
  } else {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
      showCopyFeedback();
    } catch (err) {
      console.error('Failed to copy text: ', err);
    }
    document.body.removeChild(textArea);
  }
}

function showCopyFeedback() {
  // Create a temporary feedback element
  const feedback = document.createElement('div');
  feedback.textContent = 'Copied to clipboard!';
  feedback.className = 'fixed top-4 right-4 bg-accent text-black px-4 py-2 rounded-lg font-semibold z-50';
  document.body.appendChild(feedback);
  
  // Remove after 2 seconds
  setTimeout(() => {
    if (feedback.parentNode) {
      feedback.parentNode.removeChild(feedback);
    }
  }, 2000);
}
</script>