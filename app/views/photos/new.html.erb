<!-- Upload Photo Page -->
<div class="min-h-screen bg-gray-50">
  <%= render 'shared/navigation' %>

  <!-- Main Content -->
  <div class="max-w-2xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-8">
    <!-- Usage Limits Card (for Starter users) -->
    <% unless @user.can_access_pro_features? %>
      <div class="mb-6 bg-white rounded-lg shadow-sm border p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900">Monthly Usage</h3>
          <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
            Starter Plan
          </span>
        </div>
        
        <div class="space-y-3">
          <!-- Photos Usage -->
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-600">Photos</span>
              <span class="font-medium"><%= @user.current_month_photos %>/<%= @user.effective_monthly_photo_limit %></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-accent h-2 rounded-full transition-all duration-300" style="width: <%= [@user.usage_percentage(:photos), 100].min %>%"></div>
            </div>
          </div>
          
          <!-- Captions Usage -->
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-600">AI Captions</span>
              <span class="font-medium"><%= @user.current_month_captions %>/<%= @user.effective_monthly_caption_limit %></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-accent h-2 rounded-full transition-all duration-300" style="width: <%= [@user.usage_percentage(:captions), 100].min %>%"></div>
            </div>
          </div>
        </div>
        
        <% if @user.photos_remaining_this_month <= 2 %>
          <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start">
              <span class="text-yellow-400 mr-2">‚ö†Ô∏è</span>
              <div>
                <p class="text-sm text-yellow-800 font-medium">
                  <%= @user.photos_remaining_this_month == 0 ? "Upload limit reached!" : "Almost at your limit!" %>
                </p>
                <p class="text-xs text-yellow-700 mt-1">
                  Upgrade to Pro for unlimited photos and 3 caption styles per photo.
                </p>
                <button onclick="openUpgradeModal()" class="mt-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded hover:bg-yellow-200 transition-colors">
                  Upgrade Now ‚Üí
                </button>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
    
    <!-- Header -->
    <div class="text-center mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Upload Your Photo</h1>
      <p class="text-sm sm:text-base text-gray-600 px-4">
        Upload a gym photo and we'll create engaging captions for your social media
        <% unless @user.can_access_pro_features? %>
          <br><span class="text-accent font-medium">Free: 1 caption style ‚Ä¢ Pro: 3 caption styles</span>
        <% end %>
      </p>
    </div>

    <!-- Upload Form -->
    <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-8">
      <%= form_with model: @photo, local: true, multipart: true, class: "space-y-4 sm:space-y-6" do |form| %>
        
        <!-- Error Messages -->
        <% if @photo.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <span class="text-red-400">‚ö†Ô∏è</span>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Please fix the following errors:</h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc space-y-1 pl-5">
                    <% @photo.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Photo Upload -->
        <div class="space-y-3">
          <%= form.label :image, "Choose Photo", class: "block text-sm font-medium text-gray-700" %>
          
          <!-- Drag & Drop Area -->
          <label for="photo-input" class="block border-2 border-dashed border-gray-300 rounded-lg p-6 sm:p-12 text-center hover:border-accent hover:bg-gray-50 cursor-pointer transition-all duration-200" 
                 id="drop-zone">
            <div class="space-y-3 sm:space-y-4">
              <div class="text-4xl sm:text-6xl">üì∏</div>
              <div class="text-gray-600">
                <span class="font-semibold text-accent text-base sm:text-lg">Click here to upload</span>
                <br class="hidden sm:block">
                <span class="text-sm block mt-1 sm:mt-0">
                  <span class="hidden sm:inline">or drag and drop your photo</span>
                  <span class="sm:hidden">Tap to select photo</span>
                </span>
              </div>
              <div class="text-xs sm:text-sm text-gray-500">
                PNG, JPG, WebP, HEIC up to 10MB
              </div>
              <div class="mt-3 sm:mt-4">
                <span class="inline-block bg-accent text-black px-4 py-2 sm:px-6 rounded-lg font-semibold text-sm sm:text-base">
                  Choose File
                </span>
              </div>
            </div>
          </label>
          <%= form.file_field :image, 
              accept: "image/*,.heic,.heif", 
              required: true,
              class: "hidden",
              id: "photo-input" %>
          
          <!-- Preview Area -->
          <div id="preview-area" class="hidden border-2 border-gray-300 rounded-lg p-3 sm:p-4">
            <div class="text-center">
              <img id="preview-image" class="max-w-full h-32 sm:h-48 object-cover rounded-lg mx-auto mb-2 sm:mb-3" />
              <p id="preview-name" class="text-xs sm:text-sm font-medium text-gray-900 mb-2 truncate"></p>
              <button type="button" onclick="changePhoto()" class="text-xs sm:text-sm text-accent hover:underline">
                üì∏ Change Photo
              </button>
            </div>
          </div>
        </div>

        <!-- Title -->
        <div>
          <%= form.label :title, "Photo Title (Optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :title, 
              placeholder: "e.g., Morning deadlift session", 
              class: "w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition-colors text-sm sm:text-base" %>
        </div>

        <!-- Description -->
        <div>
          <%= form.label :description, "Description (Optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_area :description, 
              placeholder: "Add any context about the photo that will help us create better captions...", 
              rows: 3,
              class: "w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition-colors resize-none text-sm sm:text-base" %>
        </div>

        <!-- Submit Button -->
        <div>
          <%= form.submit "Upload & Generate Captions", 
              class: "w-full bg-accent text-black py-3 sm:py-4 rounded-lg font-semibold text-base sm:text-lg hover:bg-accent-hover transition-colors" %>
        </div>

      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const dropZone = document.getElementById('drop-zone');
  const photoInput = document.getElementById('photo-input');
  const previewArea = document.getElementById('preview-area');
  const previewImage = document.getElementById('preview-image');
  const previewName = document.getElementById('preview-name');

  console.log('Upload script loaded');
  console.log('Drop zone:', dropZone);
  console.log('Photo input:', photoInput);

  // Click to upload - with debugging
  dropZone.addEventListener('click', function(e) {
    console.log('Drop zone clicked!');
    e.preventDefault();
    photoInput.click();
    console.log('Photo input click triggered');
  });

  // File input change
  photoInput.addEventListener('change', handleFileSelect);

  // Drag and drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-accent');
  });

  dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-accent');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-accent');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      photoInput.files = files;
      handleFileSelect();
    }
  });

  function handleFileSelect() {
    console.log('File selection triggered');
    const file = photoInput.files[0];
    console.log('Selected file:', file);
    if (file && file.type.startsWith('image/')) {
      console.log('File details:', {
        name: file.name,
        size: file.size,
        type: file.type
      });
      // Show preview immediately
      const reader = new FileReader();
      reader.onload = function(e) {
        console.log('FileReader onload triggered');
        previewImage.src = e.target.result;
        previewName.textContent = file.name;
        previewArea.classList.remove('hidden');
        dropZone.style.display = 'none'; // Force hide with inline style
        console.log('Preview updated and shown');
      };
      reader.onerror = function(e) {
        console.error('FileReader error:', e);
      };
      reader.readAsDataURL(file);
    } else {
      console.log('No valid image file selected');
      // Reset if invalid file
      previewArea.classList.add('hidden');
      dropZone.style.display = 'block';
    }
  }

  // Add global changePhoto function
  window.changePhoto = function() {
    console.log('Change photo clicked');
    previewArea.classList.add('hidden');
    dropZone.style.display = 'block';
    photoInput.value = ''; // Clear the input
    photoInput.click();
  };
});
</script>