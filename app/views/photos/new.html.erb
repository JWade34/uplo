<% content_for :title, "Upload & Generate AI Captions | Uplo" %>
<% content_for :description, "Upload your gym photos and get personalized AI-generated captions that sound like you and drive engagement. Perfect for personal trainers and fitness professionals." %>
<% content_for :keywords, "upload gym photo, AI caption generator, fitness social media, personal trainer content, gym photo captions" %>
<% content_for :og_title, "Upload & Generate AI Captions - Uplo" %>
<% content_for :og_description, "Transform your gym photos into engaging social media posts with AI-powered caption generation." %>
<% content_for :robots, "noindex, follow" %>

<!-- Upload Photo Page -->
<div class="min-h-screen bg-gray-50">
  <%= render 'shared/navigation' %>

  <!-- Main Content -->
  <div class="max-w-2xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-8">
    <!-- Smart Upgrade Prompts (for Starter users) -->
    <% unless @user.can_access_pro_features? %>
      <% photos_remaining = @user.photos_remaining_this_month %>
      
      <% if photos_remaining == 0 %>
        <!-- No Photos Left - Strong Upgrade CTA -->
        <div class="mb-6 bg-gradient-to-r from-red-50 to-red-100 rounded-lg shadow-lg border-2 border-red-300 p-6">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-red-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3 flex-1">
              <h3 class="text-lg font-bold text-red-800">Monthly Upload Limit Reached</h3>
              <p class="mt-2 text-sm text-red-700">
                You've used all <%= @user.effective_monthly_photo_limit %> photos for this month. 
                Don't lose momentum - upgrade now to keep growing your business!
              </p>
              <div class="mt-4 bg-white rounded-lg p-3 border border-red-200">
                <p class="text-xs font-semibold text-gray-800 mb-2">What you're missing out on:</p>
                <ul class="text-xs text-gray-700 space-y-1">
                  <li class="flex items-start"><span class="text-red-500 mr-1">‚úó</span> Unlimited photo uploads</li>
                  <li class="flex items-start"><span class="text-red-500 mr-1">‚úó</span> 3 caption variations per photo</li>
                  <li class="flex items-start"><span class="text-red-500 mr-1">‚úó</span> Advanced analytics & insights</li>
                </ul>
              </div>
              <div class="mt-4 flex flex-col sm:flex-row gap-3">
                <button onclick="openUpgradeModal()" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                  Upgrade to Pro - 14 Day Trial
                </button>
                <%= link_to "View All Plans", pricing_path, class: "text-center text-red-800 font-medium hover:text-red-700" %>
              </div>
            </div>
          </div>
        </div>
        
      <% elsif photos_remaining <= 2 %>
        <!-- Almost Out - Urgent Warning -->
        <div class="mb-6 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg shadow-md border-2 border-yellow-300 p-5">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <span class="text-2xl">‚ö†Ô∏è</span>
            </div>
            <div class="ml-3 flex-1">
              <h3 class="text-base font-bold text-yellow-800">
                Only <%= photos_remaining %> <%= photos_remaining == 1 ? 'Upload' : 'Uploads' %> Left This Month!
              </h3>
              <p class="mt-1 text-sm text-yellow-700">
                You're about to hit your limit. Keep your social media active with Pro!
              </p>
              <div class="mt-3 bg-white rounded-lg p-3 border border-yellow-200">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-semibold text-gray-800">Pro Benefits:</span>
                  <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Save $78/year</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs text-gray-700">
                  <div>‚úì Unlimited uploads</div>
                  <div>‚úì 3 caption styles</div>
                  <div>‚úì Competitor analysis</div>
                  <div>‚úì Export reports</div>
                </div>
              </div>
              <button onclick="openUpgradeModal()" class="mt-3 w-full bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition-colors text-sm">
                Start Free 14-Day Trial ‚Üí
              </button>
            </div>
          </div>
        </div>
        
      <% else %>
        <!-- Regular Usage Display -->
        <div class="mb-6 bg-white rounded-lg shadow-sm border p-4 sm:p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">Monthly Usage</h3>
            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
              Starter Plan
            </span>
          </div>
          
          <div class="space-y-3">
            <!-- Photos Usage -->
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Photos</span>
                <span class="font-medium"><%= @user.current_month_photos %>/<%= @user.effective_monthly_photo_limit %></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-accent h-2 rounded-full transition-all duration-300" style="width: <%= [@user.usage_percentage(:photos), 100].min %>%"></div>
              </div>
            </div>
            
            <!-- Captions Usage -->
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">AI Captions</span>
                <span class="font-medium"><%= @user.current_month_captions %>/<%= @user.effective_monthly_caption_limit %></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-accent h-2 rounded-full transition-all duration-300" style="width: <%= [@user.usage_percentage(:captions), 100].min %>%"></div>
              </div>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-accent/10 rounded-lg">
            <p class="text-xs text-gray-700">
              <strong><%= photos_remaining %></strong> photos, <strong><%= @user.captions_remaining_this_month %></strong> captions remaining
            </p>
            <button onclick="openUpgradeModal()" class="mt-2 text-xs font-medium text-blue-800 hover:text-blue-700">
              Want unlimited? See Pro plans ‚Üí
            </button>
          </div>
        </div>
      <% end %>
      
    <% else %>
      <!-- Pro User Badge -->
      <div class="mb-6 bg-gradient-to-r from-accent/20 to-green-100 rounded-lg shadow-sm p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <span class="text-2xl mr-3">üíé</span>
            <div>
              <h3 class="text-sm font-bold text-gray-900">Pro Member</h3>
              <p class="text-xs text-gray-600">Unlimited uploads ‚Ä¢ 3 caption styles ‚Ä¢ Advanced analytics</p>
            </div>
          </div>
          <%= link_to "Manage Plan", pricing_path, class: "text-xs text-gray-700 hover:text-gray-900 font-medium" %>
        </div>
      </div>
    <% end %>
    
    <!-- Header -->
    <div class="text-center mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Upload Your Photo</h1>
      <p class="text-sm sm:text-base text-gray-600 px-4">
        Upload a gym photo and we'll create engaging captions for your social media
        <% unless @user.can_access_pro_features? %>
          <br><span class="text-accent font-medium">Free: 1 caption style ‚Ä¢ Pro: 3 caption styles</span>
        <% end %>
      </p>
    </div>

    <!-- Upload Form -->
    <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-8">
      <%= form_with model: @photo, local: true, multipart: true, class: "space-y-4 sm:space-y-6" do |form| %>
        
        <!-- Error Messages -->
        <% if @photo.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <span class="text-red-400">‚ö†Ô∏è</span>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Please fix the following errors:</h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc space-y-1 pl-5">
                    <% @photo.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Photo Upload -->
        <div class="space-y-3">
          <%= form.label :image, "Choose Photo", class: "block text-sm font-medium text-gray-700" %>
          
          <!-- Drag & Drop Area -->
          <label for="photo-input" class="block border-2 border-dashed border-gray-300 rounded-lg p-6 sm:p-12 text-center hover:border-accent hover:bg-gray-50 cursor-pointer transition-all duration-200" 
                 id="drop-zone">
            <div class="space-y-3 sm:space-y-4">
              <div class="text-4xl sm:text-6xl">üì∏</div>
              <div class="text-gray-600">
                <span class="font-semibold text-accent text-base sm:text-lg">Click here to upload</span>
                <br class="hidden sm:block">
                <span class="text-sm block mt-1 sm:mt-0">
                  <span class="hidden sm:inline">or drag and drop your photo</span>
                  <span class="sm:hidden">Tap to select photo</span>
                </span>
              </div>
              <div class="text-xs sm:text-sm text-gray-500">
                PNG, JPG, WebP, HEIC up to 10MB
              </div>
              <div class="mt-3 sm:mt-4">
                <span class="inline-block bg-accent text-black px-4 py-2 sm:px-6 rounded-lg font-semibold text-sm sm:text-base">
                  Choose File
                </span>
              </div>
            </div>
          </label>
          <%= form.file_field :image, 
              accept: "image/*,.heic,.heif", 
              required: true,
              class: "hidden",
              id: "photo-input" %>
          
          <!-- Preview Area -->
          <div id="preview-area" class="hidden border-2 border-accent bg-accent/5 rounded-lg p-3 sm:p-4">
            <div class="text-center">
              <div class="mb-3 sm:mb-4">
                <img id="preview-image" class="max-w-full h-48 sm:h-64 object-cover rounded-lg mx-auto shadow-sm" alt="Photo preview" />
              </div>
              <p id="preview-name" class="text-sm font-medium text-gray-900 mb-3 px-2"></p>
              <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 justify-center">
                <button type="button" onclick="changePhoto()" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-accent bg-white border border-accent rounded-lg hover:bg-accent hover:text-black transition-colors">
                  üì∏ Change Photo
                </button>
                <span class="text-xs text-gray-600 flex items-center justify-center">
                  ‚úÖ Ready to upload
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Title -->
        <div>
          <%= form.label :title, "Photo Title (Optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :title, 
              placeholder: "e.g., Morning deadlift session", 
              class: "w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition-colors text-sm sm:text-base" %>
        </div>

        <!-- Description -->
        <div>
          <%= form.label :description, "Description (Optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_area :description, 
              placeholder: "Add any context about the photo that will help us create better captions...", 
              rows: 3,
              class: "w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition-colors resize-none text-sm sm:text-base" %>
        </div>

        <!-- Submit Button -->
        <div>
          <%= form.submit "Upload & Generate Captions", 
              class: "w-full bg-accent text-black py-3 sm:py-4 rounded-lg font-semibold text-base sm:text-lg hover:bg-accent-hover transition-colors" %>
        </div>

      <% end %>
    </div>
  </div>
</div>

<script>
function initPhotoUpload() {
  const dropZone = document.getElementById('drop-zone');
  const photoInput = document.getElementById('photo-input');
  const previewArea = document.getElementById('preview-area');
  const previewImage = document.getElementById('preview-image');
  const previewName = document.getElementById('preview-name');

  if (!dropZone || !photoInput) return; // Exit if elements don't exist

  console.log('Upload script loaded');
  console.log('Drop zone:', dropZone);
  console.log('Photo input:', photoInput);

  // Remove any existing event listeners to prevent duplicates
  const newDropZone = dropZone.cloneNode(true);
  dropZone.parentNode.replaceChild(newDropZone, dropZone);
  const newPhotoInput = photoInput.cloneNode(true);
  photoInput.parentNode.replaceChild(newPhotoInput, photoInput);

  // Re-get references after cloning
  const activeDropZone = document.getElementById('drop-zone');
  const activePhotoInput = document.getElementById('photo-input');

  // Click to upload - with debugging
  activeDropZone.addEventListener('click', function(e) {
    console.log('Drop zone clicked!');
    e.preventDefault();
    activePhotoInput.click();
    console.log('Photo input click triggered');
  });

  // File input change
  activePhotoInput.addEventListener('change', handleFileSelect);

  // Drag and drop
  activeDropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    activeDropZone.classList.add('border-accent');
  });

  activeDropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    activeDropZone.classList.remove('border-accent');
  });

  activeDropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    activeDropZone.classList.remove('border-accent');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      activePhotoInput.files = files;
      handleFileSelect();
    }
  });

  function handleFileSelect() {
    console.log('File selection triggered');
    const file = activePhotoInput.files[0];
    console.log('Selected file:', file);
    
    if (file) {
      // Check if it's an image file (including HEIC)
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/heic', 'image/heif'];
      const isValidImage = file.type.startsWith('image/') || validTypes.includes(file.type.toLowerCase()) || 
                          file.name.toLowerCase().match(/\.(jpg|jpeg|png|webp|heic|heif)$/);
      
      if (isValidImage) {
        console.log('File details:', {
          name: file.name,
          size: file.size,
          type: file.type
        });
        
        // Show preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
          console.log('FileReader onload triggered');
          const currentPreviewImage = document.getElementById('preview-image');
          const currentPreviewName = document.getElementById('preview-name');
          const currentPreviewArea = document.getElementById('preview-area');
          const currentDropZone = document.getElementById('drop-zone');
          
          if (currentPreviewImage && currentPreviewName) {
            currentPreviewImage.src = e.target.result;
            currentPreviewName.textContent = file.name;
            
            // Add file size info
            const fileSize = (file.size / (1024 * 1024)).toFixed(1);
            currentPreviewName.textContent = `${file.name} (${fileSize} MB)`;
            
            // Show preview, hide upload area
            if (currentPreviewArea) currentPreviewArea.classList.remove('hidden');
            if (currentDropZone) currentDropZone.classList.add('hidden');
            console.log('Preview updated and shown');
          }
        };
        
        reader.onerror = function(e) {
          console.error('FileReader error:', e);
          alert('Error reading file. Please try again.');
        };
        
        reader.readAsDataURL(file);
      } else {
        console.log('Invalid file type selected:', file.type);
        alert('Please select a valid image file (JPG, PNG, WebP, HEIC)');
        // Reset if invalid file
        const currentPreviewArea = document.getElementById('preview-area');
        const currentDropZone = document.getElementById('drop-zone');
        if (currentPreviewArea) currentPreviewArea.classList.add('hidden');
        if (currentDropZone) currentDropZone.classList.remove('hidden');
        activePhotoInput.value = '';
      }
    } else {
      console.log('No file selected');
      // Reset if no file
      const currentPreviewArea = document.getElementById('preview-area');
      const currentDropZone = document.getElementById('drop-zone');
      if (currentPreviewArea) currentPreviewArea.classList.add('hidden');
      if (currentDropZone) currentDropZone.classList.remove('hidden');
    }
  }

  // Add global changePhoto function
  window.changePhoto = function() {
    console.log('Change photo clicked');
    const currentPreviewArea = document.getElementById('preview-area');
    const currentDropZone = document.getElementById('drop-zone');
    const currentPhotoInput = document.getElementById('photo-input');
    
    if (currentPreviewArea) currentPreviewArea.classList.add('hidden');
    if (currentDropZone) currentDropZone.classList.remove('hidden');
    if (currentPhotoInput) {
      currentPhotoInput.value = ''; // Clear the input
      currentPhotoInput.click();
    }
  };
}

// Initialize on DOMContentLoaded (first page load)
document.addEventListener('DOMContentLoaded', initPhotoUpload);

// Initialize on Turbo load (subsequent navigations)
document.addEventListener('turbo:load', initPhotoUpload);

// Also reinitialize after Turbo renders (for form submissions and frame updates)
document.addEventListener('turbo:render', initPhotoUpload);
</script>